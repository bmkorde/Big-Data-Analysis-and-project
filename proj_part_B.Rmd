---
title: "part_b"
author: "BK"
date: "2025-07-04"
output: pdf_document
---

```{r setup, include=FALSE}
# Global chunk options: ensures all code chunks run with echo enabled by default
knitr::opts_chunk$set(echo = TRUE)
```

#Load Libraries and Datasets
```{r}
# Load core libraries for data wrangling, visualization, and clustering
library(tidyverse)
library(readr)
library(cluster)
# Read air quality dataset
air_quality <- read.csv("data/data.csv")
# Read global land temperature dataset
land_temp <- read.csv("data/GlobalLandTemperaturesByCity.csv")
# Read food price dataset 
food_prices <- read.csv("data/wfp_food_prices_global_merged_1990-2025.csv")

```

#Data Cleaning and Preprocessing
```{r}
# Keep only relevant columns and rename for clarity
# Filter out rows without PM2.5 data
air_quality_clean <- air_quality %>%
  select(date = `date`, state, location, type, pm2_5, no2, so2, rspm) %>%
  filter(!is.na(pm2_5))  
# Select key columns for land temperature and parse date
land_temp_clean <- land_temp %>%
  select('date' = dt, 'Average_temp' = AverageTemperature, City, Country) %>%
  filter(!is.na(Average_temp))
land_temp_clean <- land_temp_clean %>%
  mutate(date = as.Date(date, format = "%Y-%m-%d")) 
# Clean food prices dataset: remove extra header row and keep relevant columns
food_prices <- food_prices[-1, ]
food_prices_clean <- food_prices %>%
  select(
    country = countryiso3,
    date,
    admin1,
    category,
    commodity,
    unit,
    price_usd = usdprice
  ) %>%
  filter(!is.na(price_usd))
food_prices_clean <- food_prices_clean[food_prices_clean[[1]] != "#country+code", ]

```



```{r}
# Quick summaries for each cleaned dataset to verify data types and missing values
summary(air_quality_clean)
summary(land_temp_clean)
summary(food_prices_clean)
```

# Global average temperature over time
```{r}
# Aggregate global monthly average temperature and plot
land_temp_clean %>%
  group_by(date) %>%
  summarise(global_avg_temp = mean(Average_temp, na.rm = TRUE)) %>%
  ggplot(aes(x = as.Date(date), y = global_avg_temp)) +
  geom_line(color = "firebrick") +
  labs(title = "Global Average Temperature Over Time")



library(scales)
library(ggthemes)

land_temp_clean %>%
  group_by(date) %>%
  summarise(global_avg_temp = mean(Average_temp, na.rm = TRUE)) %>%
  ggplot(aes(x = as.Date(date), y = global_avg_temp)) +
  geom_line(color = "firebrick", linewidth = 1.2) +
  labs(
    title = 'Global Average Temperature Trend',
    subtitle = "Monthly aggregated average temperature worldwide",
    x = "Date",
    y = "Avg Temperature (°C)"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(face = "bold", size = 16, color = "#333333"),
    plot.subtitle = element_text(size = 12, color = "#666666"),
    axis.title = element_text(face = "bold"),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    panel.border = element_rect(color = "black", fill = NA, linewidth = 1),
    panel.grid.minor = element_blank()
  ) +
  scale_y_continuous(labels = label_number(suffix = "°C"))


```


```{r}
# Ensure dates and prices are in correct formats
food_prices_clean <- food_prices_clean %>%
  mutate(date = as.Date(date, format = "%Y-%m-%d"))  # adjust format accordingly
food_prices_clean <- food_prices_clean %>%
  mutate(price_usd = as.numeric(price_usd))
 air_quality_clean<- air_quality_clean %>%
  mutate(date = as.Date(date, format = "%Y-%m-%d"))
```

# Global rice price trend
```{r}
# Summarise average global rice price over time
rice_summary <- food_prices_clean %>%
  filter(commodity == "Rice (imported)") %>%
  group_by(date) %>%
  summarise(avg_price = mean(price_usd, na.rm = TRUE))
summary(rice_summary)
library(scales)
library(ggthemes)
# Plot rice price trend
food_prices_clean %>%
  filter(commodity == "Rice (imported)") %>%
  group_by(date) %>%
  summarise(avg_price = mean(price_usd, na.rm = TRUE)) %>%
  ggplot(aes(x = as.Date(date), y = avg_price)) +
  geom_line(color = "darkgreen", linewidth = 1.2) +
  labs(
    title = 'Global Rice Price Trend',
    subtitle = "Average monthly price of imported rice (USD)",
    x = "Date",
    y = "Average Price (USD)"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(face = "bold", size = 16, color = "#2E4E2E"),
    plot.subtitle = element_text(size = 12, color = "#556B2F"),
    axis.title = element_text(face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.border = element_rect(color = "black", fill = NA, linewidth = 1),
    panel.grid.minor = element_blank()
  ) +
  scale_x_date(date_breaks = "5 years", date_labels = "%Y") +
  scale_y_continuous(labels = dollar_format(prefix = "$"))




```

#Seasonal Temperature Variation
```{r}
# Calculate and plot average global temperature by month
land_temp_clean %>%
  mutate(month = lubridate::month(as.Date(date), label = TRUE)) %>%
  group_by(month) %>%
  summarise(avg_temp = mean(Average_temp, na.rm = TRUE)) %>%
  ggplot(aes(x = month, y = avg_temp)) +
  geom_col(fill = "skyblue") +
  labs(title = "Average Global Temperature by Month")

```

# Clustering Locations by Air Quality
```{r}
summary(air_quality_clean)
# Compute average pollutant levels per location
air_quality_cluster <- air_quality_clean %>%
  group_by(location) %>%
  summarise(across(c(pm2_5, no2, so2, rspm), ~mean(.x, na.rm = TRUE))) %>%
  na.omit()



set.seed(123)
# Prepare numeric data for clustering
air_quality_cluster_numeric <- air_quality_cluster %>%
  mutate(across(-1, ~as.numeric(as.character(.))))
# Apply K-means clustering (3 clusters)
clusters <- kmeans(air_quality_cluster[,-1], centers = 3)
air_quality_cluster$cluster <- as.factor(clusters$cluster)

library(ggthemes)
# Plot PM2.5 vs NO2 with clusters
ggplot(air_quality_cluster, aes(x = pm2_5, y = no2, color = cluster)) +
  geom_point(size = 4, alpha = 0.8) +
  labs(
    title = 'Clustering Locations by Pollutant Concentration',
    subtitle = "Based on average PM2.5 and NO2 levels",
    x = "PM2.5 Concentration (μg/m³)",
    y = "NO2 Concentration (μg/m³)",
    color = "Cluster"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(face = "bold", size = 16, color = "#333333"),
    plot.subtitle = element_text(size = 12, color = "#666666"),
    axis.title = element_text(face = "bold"),
    legend.title = element_text(face = "bold"),
    panel.border = element_rect(color = "black", fill = NA, linewidth = 1),
    panel.grid.minor = element_blank()
  ) +
  scale_color_brewer(palette = "Set1")



```

#Merging Temperature and Rice Price Data
```{r}
# Align rice price dates to the first of each month
rice_summary <- rice_summary %>%
  mutate(date = as.Date(format(date, "%Y-%m-01")))
# Merge rice price with monthly global temperature
merged_data <- inner_join(rice_summary, 
                          land_temp_clean %>%
                            group_by(date) %>%
                            summarise(global_avg_temp = mean(Average_temp, na.rm = TRUE)),
                          by = "date")
# Scatter plot with linear fit: Temperature vs. Rice Price
ggplot(merged_data, aes(x = global_avg_temp, y = avg_price)) +
  geom_point() +
  geom_smooth(method = "lm", color = "red") +
  labs(title = "Relationship between Temperature and Rice Prices",
       x = "Global Avg Temp (°C)", y = "Avg Rice Price (USD)")

# Scatter plot with LOESS smoother (non-linear fit)
ggplot(merged_data, aes(x = global_avg_temp, y = avg_price)) +
  geom_point(color = "darkblue", alpha = 0.6, size = 2) +
  geom_smooth(method = "loess", span = 0.6, se = TRUE, color = "purple", linewidth = 1.2) +
  labs(
    title = ' Global Temperature vs. Rice Price (LOESS Smoother)',
    subtitle = "Non-linear fit reveals subtle patterns in the relationship",
    x = "Global Avg Temp (°C)",
    y = "Avg Rice Price (USD)"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(face = "bold", size = 16),
    plot.subtitle = element_text(size = 12, color = "#666666"),
    axis.title = element_text(face = "bold"),
    panel.border = element_rect(color = "black", fill = NA, linewidth = 1),
    panel.grid.minor = element_blank()
  )

```

#Correlation Matrix for Air Pollutants

```{r}
library(GGally)
# Select pollutant columns, remove missing values
cor_data <- air_quality_clean %>%
  select(pm2_5, no2, so2, rspm) %>%
  na.omit()
# Pairwise scatterplots + correlation matrix
ggpairs(cor_data)

```

#Seasonal Decomposition of Temperature
```{r}
library(forecast)
# Convert temperature data to time series (monthly frequency)
temp_ts <- ts(land_temp_clean$Average_temp, frequency = 12)
# Seasonal-Trend decomposition using LOESS
decomp <- stl(temp_ts, s.window = "periodic")
# Plot trend, seasonal, and residual components
plot(decomp)

```

#India-specific PM2.5 vs Rice Price Trends
```{r}
ggplot(merged_data, aes(x = global_avg_temp, y = avg_price)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "loess", span = 0.3, color = "purple") +
  labs(title = "Non-linear Fit: Temperature vs Rice Prices")

```
```{r}
# Filter India-specific rice data
india_prices <- food_prices_clean %>%
  filter(country == "IND", commodity == "Rice") %>%
  group_by(date) %>%
  summarise(avg_price_india = mean(price_usd, na.rm = TRUE))

# National average PM2.5 (can group by state or weight by city population later)
india_pollution <- air_quality_clean %>%
  filter(state == "Delhi" | state == "Maharashtra") %>%  # use more states if needed
  group_by(date) %>%
  summarise(mean_pm2_5 = mean(pm2_5, na.rm = TRUE))

# Merge and plot
merged_india <- inner_join(india_prices, india_pollution, by = "date")

ggplot(merged_india) +
  geom_line(aes(x = date, y = mean_pm2_5), color = "firebrick", linewidth = 1) +
  geom_line(aes(x = date, y = avg_price_india * 5), color = "navy", linetype = "dashed") +
  labs(title = "India PM2.5 vs. Rice Price", 
       y = "PM2.5 / Scaled Price (dashed)", x = NULL)

library(scales)
library(ggthemes)
# Plot PM2.5 and scaled rice price trend together
ggplot(merged_india) +
  geom_line(aes(x = date, y = mean_pm2_5), color = "firebrick", linewidth = 1.2) +
  geom_line(aes(x = date, y = avg_price_india * 5), color = "navy", linetype = "dashed", linewidth = 1) +
  labs(
    title = 'India PM2.5 vs. Rice Price Trend',
    subtitle = "Comparing air pollution levels and scaled rice prices over time",
    x = "Rice Price(Scaled)",
    y = "PM2.5 Concentration"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(face = "bold", size = 16, color = "#333333"),
    plot.subtitle = element_text(size = 12, color = "#666666"),
    axis.title = element_text(face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.border = element_rect(color = "black", fill = NA, linewidth = 1),
    panel.grid.minor = element_blank(),
    legend.position = "none"
  ) +
  scale_x_date(date_breaks = "2 years", date_labels = "%Y")

```
#State-level Air Quality Clustering & Price Volatility
```{r}
# Create state-level air quality cluster data
air_quality_state_cluster <- air_quality_clean %>%
  group_by(state) %>%
  summarise(across(c(pm2_5, no2, so2, rspm), mean, na.rm = TRUE)) %>%
  na.omit()

# Apply clustering
set.seed(123)
clusters <- kmeans(air_quality_state_cluster[,-1], centers = 3)
air_quality_state_cluster$cluster <- as.factor(clusters$cluster)

# Add state info to food price
india_prices_state <- food_prices_clean %>%
  filter(country == "IND", commodity == "Rice") %>%
  left_join(air_quality_clean %>% select(state) %>% distinct(), by = character()) %>%  # create synthetic state info if not available
  group_by(state, date) %>%
  summarise(avg_price = mean(price_usd, na.rm = TRUE), .groups = "drop")

# Join with clusters
rice_with_state_cluster <- inner_join(india_prices_state, air_quality_state_cluster, by = "state")



ggplot(rice_with_state_cluster, aes(x = date, y = avg_price, color = cluster)) +
  geom_line(alpha = 0.6) +
  labs(title = "Rice Price Trends by Pollution Cluster", y = "Avg Price (USD)")


library(zoo)

# Calculate rolling 3-month price volatility by cluster
rice_volatility <- rice_with_state_cluster %>%
  group_by(cluster) %>%
  arrange(date) %>%
  mutate(rolling_sd = rollapply(avg_price, width = 3, FUN = sd, fill = NA, align = "right")) %>%
  ungroup()

ggplot(rice_volatility, aes(x = date, y = rolling_sd, color = cluster)) +
  geom_line() +
  labs(title = "3-Month Rolling Rice Price Volatility by Cluster", y = "Volatility (SD)")

library(scales)
library(ggthemes)
# Plot volatility over time
ggplot(rice_volatility, aes(x = date, y = rolling_sd, color = cluster)) +
  geom_line(linewidth = 1.2, alpha = 0.9) +
  labs(
    title = 'Rice Price Volatility by Air Pollution Cluster',
    subtitle = "3-Month Rolling Standard Deviation by Clustered State Profiles",
    x = "Date",
    y = "Rolling Volatility (SD)",
    color = "Pollution Cluster"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(face = "bold", size = 16, color = "#222222"),
    plot.subtitle = element_text(size = 12, color = "#555555"),
    axis.title = element_text(face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.border = element_rect(color = "black", fill = NA, linewidth = 1),
    panel.grid.minor = element_blank()
  ) +
  scale_color_brewer(palette = "Dark2") +
  scale_x_date(date_breaks = "2 years", date_labels = "%Y")

```


#Predictive Modelling (Linear Regression, RF, XGBoost, Time Series)
```{r}
# Prepare data for time series regression
install.packages('dynlm')
library(dynlm)
library(lubridate)

# Filter India-specific data
regression_data <- rice_with_state_cluster %>%
  group_by(date) %>%
  summarise(
    avg_price = mean(avg_price, na.rm = TRUE),
    mean_pm2_5 = mean(pm2_5, na.rm = TRUE)
  ) %>%
  arrange(date)

# Create lag variables (1-month and 2-month lag)
regression_data <- regression_data %>%
  mutate(
    pm2_5_lag1 = lag(mean_pm2_5, 1),
    pm2_5_lag2 = lag(mean_pm2_5, 2)
  )

# Fit the time series regression model
ts_model <- dynlm(avg_price ~ L(pm2_5_lag1) + L(pm2_5_lag2), data = regression_data)

#Review the regression result
summary(ts_model)

```



```{r}
# Create monthly aggregated temperature
monthly_temp <- land_temp_clean %>%
  group_by(date) %>%
  summarise(global_avg_temp = mean(Average_temp, na.rm = TRUE))
rice_with_state_cluster <- rice_with_state_cluster %>%
  mutate(date = as.Date(format(date, "%Y-%m-01")))
# Join global temperature to rice + pollution data
regression_data <- rice_with_state_cluster %>%
  group_by(date) %>%
  summarise(
    avg_price = mean(avg_price, na.rm = TRUE),
    mean_pm2_5 = mean(pm2_5, na.rm = TRUE),
    no2 = mean(no2, na.rm = TRUE)  # Add NO2 here if you want to use it in models
  ) %>%
  left_join(monthly_temp, by = "date") %>%
  arrange(date) %>%
  mutate(
    pm2_5_lag1 = lag(mean_pm2_5, 1),
    pm2_5_lag2 = lag(mean_pm2_5, 2),
    month = lubridate::month(date)
  )

```




```{r}
# Linear Regression
library(xgboost)
regression_data_clean <- regression_data %>% drop_na()
lm_model <- lm(avg_price ~ mean_pm2_5 + global_avg_temp + no2, data = regression_data_clean)
summary(lm_model)
cor(regression_data %>% select(mean_pm2_5, global_avg_temp, no2), use = "complete.obs")

# Random Forest
library(randomForest)
rforest_model <- randomForest(avg_price ~ mean_pm2_5 + global_avg_temp + no2 + month,
                              data = regression_data_clean, ntree = 500, importance = TRUE)
importance(rforest_model)


# XGBoost
x_data <- regression_data %>% drop_na()
x_matrix <- model.matrix(avg_price ~ . - date, data = x_data)[, -1]
y_vector <- x_data$avg_price
library(xgboost)
xgb_model <- xgboost(data = x_matrix, label = y_vector, nrounds = 100, objective = "reg:squarederror")

```



# Time Series Regression
```{r}
library(dynlm)
model <- dynlm(avg_price ~ L(pm2_5_lag1) + L(pm2_5_lag2), data = regression_data_clean)
summary(model)
```


```{r}
# Load libraries
library(tidyverse)
library(caret)
library(randomForest)
library(xgboost)
library(dynlm)

# Clean data (drop NAs)
regression_data_clean <- regression_data %>% drop_na()

# --------------------------------------------
# Linear Regression
# --------------------------------------------
lm_model <- lm(avg_price ~ mean_pm2_5 + global_avg_temp + no2, data = regression_data_clean)
lm_preds <- predict(lm_model, newdata = regression_data_clean)

rmse_lm <- RMSE(lm_preds, regression_data_clean$avg_price)
r2_lm <- R2(lm_preds, regression_data_clean$avg_price)

cat("Linear Regression:\n")
cat("  RMSE:", round(rmse_lm, 3), "\n")
cat("  R²:", round(r2_lm, 3), "\n\n")

# --------------------------------------------
# Random Forest
# --------------------------------------------
rforest_model <- randomForest(
  avg_price ~ mean_pm2_5 + global_avg_temp + no2 + month,
  data = regression_data_clean,
  ntree = 500,
  importance = TRUE
)
rf_preds <- predict(rforest_model, newdata = regression_data_clean)

rmse_rf <- RMSE(rf_preds, regression_data_clean$avg_price)
r2_rf <- R2(rf_preds, regression_data_clean$avg_price)

cat("Random Forest:\n")
cat("  RMSE:", round(rmse_rf, 3), "\n")
cat("  R²:", round(r2_rf, 3), "\n\n")

# --------------------------------------------
# XGBoost
# --------------------------------------------
x_data <- regression_data_clean %>%
  mutate(month = as.numeric(month))  # Ensure month is numeric

x_matrix <- model.matrix(avg_price ~ . - date, data = x_data)[, -1]
y_vector <- x_data$avg_price

xgb_model <- xgboost(data = x_matrix, label = y_vector,
                     nrounds = 100, objective = "reg:squarederror", verbose = 0)

xgb_preds <- predict(xgb_model, newdata = x_matrix)

rmse_xgb <- RMSE(xgb_preds, y_vector)
r2_xgb <- R2(xgb_preds, y_vector)

cat("XGBoost:\n")
cat("  RMSE:", round(rmse_xgb, 3), "\n")
cat("  R²:", round(r2_xgb, 3), "\n\n")

# --------------------------------------------
# Time Series Regression (dynlm)
# --------------------------------------------
ts_model <- dynlm(avg_price ~ L(pm2_5_lag1) + L(pm2_5_lag2), data = regression_data_clean)
ts_preds <- fitted(ts_model)

# Drop NAs due to lag
valid_idx <- complete.cases(ts_preds, regression_data_clean$avg_price)
rmse_ts <- RMSE(ts_preds[valid_idx], regression_data_clean$avg_price[valid_idx])
r2_ts <- R2(ts_preds[valid_idx], regression_data_clean$avg_price[valid_idx])

cat("Time Series Regression (dynlm):\n")
cat("  RMSE:", round(rmse_ts, 3), "\n")
cat("  R²:", round(r2_ts, 3), "\n\n")

# --------------------------------------------
#Combine results in a table
# --------------------------------------------
model_results <- tibble(
  Model = c("Linear Regression", "Random Forest", "XGBoost", "Time Series Regression"),
  RMSE = c(rmse_lm, rmse_rf, rmse_xgb, rmse_ts),
  R2 = c(r2_lm, r2_rf, r2_xgb, r2_ts)
)

print(model_results)

```


```{r}
library(ggplot2)

df_xgb <- data.frame(
  Actual = y_vector,
  Predicted = xgb_preds
)

ggplot(df_xgb, aes(x = Actual, y = Predicted)) +
  geom_point(color = "#2c3e50", alpha = 0.7, size = 2, shape = 16) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "#e74c3c", linewidth = 1) +  # fixed linewidth
  labs(
    title = "XGBoost Model: Actual vs Predicted Rice Prices",
    subtitle = "Closer clustering around the dashed line indicates higher accuracy",
    x = "Actual Price (USD)",
    y = "Predicted Price (USD)"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(face = "bold", size = 16, hjust = 0.5),
    plot.subtitle = element_text(size = 12, hjust = 0.5, color = "gray40"),
    panel.border = element_rect(color = "black", fill = NA, linewidth = 0.8),  # fixed linewidth
    panel.grid.minor = element_blank(),
    panel.grid.major = element_line(color = "gray85"),
    axis.text = element_text(size = 11),
    axis.title = element_text(size = 13)
  )



```

```{r}
library(ggplot2)
ggplot(model_results, aes(x = Model, y = RMSE, fill = Model)) +
  geom_col() +
  labs(title = "RMSE Comparison of Models", y = "RMSE", x = "") +
  theme_minimal() +
  scale_fill_brewer(palette = "Set3")

```

